!function(a){"use strict";function b(a,c,d){return b.constructorOf(this)?void this.init(a,c,d):new b(a,c,d)}var c=0,d=function(a){return a},e=function(a){var c=this._checkAndsState(a);this.isComplete()&&c.size===c[b.DONE]+c[b.FAIL]&&(c[b.FAIL]||this.state===b.FAIL?this._nextReject(this.result):this._nextResolve(this.result,!0))};b.TODO="todo",b.DONE="done",b.FAIL="fail",b.PROGRESS="progress",b.prototype={constructor:b,_nextResolve:function(a,c){var d,e=this.state===b.DONE,f=this.next;return(e||c)&&(d=this._checkAndsState(a),e=d.size===d[b.DONE]+d[b.FAIL]),e&&(a=d.result,f?f.resolve(a):this._finally(a,b.DONE)),this},_checkAndsState:function(a){var c,d=0,e=this.ands.length,f={size:e,result:e?[a]:a};for(f[b.TODO]=0,f[b.PROGRESS]=0,f[b.FAIL]=0,f[b.DONE]=0;e>d;d++)c=this.ands[d],f[c.state]++,f.result.push(c.result);return f},_nextReject:function(a,c){var d=this.next,e=this._checkAndsState(a),f=e.size===e[b.DONE]+e[b.FAIL];return f&&(a=e.result,d&&!c?this.next.reject(a):this._finally(a,b.FAIL)),this},_push:function(a){return this.ands.push(a),this},call:function(a,c){switch(a){case b.FAIL:case b.PROGRESS:case b.TODO:break;default:a=b.TODO}return this[a].call(this.context,c)},get:function(a){return this[a]},withContext:function(a){return this.context=a,this},_createPromiseWithoutPrev:function(a,c,d){if(b.constructorOf(a)){if(!a.prev)return a;c=a.fail,d=a.progress,a=a.todo}return new b(a,c,d)},then:function(a,c,d){if(this.next)return this.next;var e=this._createPromiseWithoutPrev(a,c,d);switch(this.context!==this&&e.withContext(this.context),e.prev=this,this.next=e,this.state){case b.FAIL:break;case b.DONE:this._nextResolve(this.result)}return e},init:function(a,e,f){return this.context=this,this.__promiseFlag=!0,this.state=b.TODO,this.result=null,this.ands=[],this.todo=a||d,this.fail=e||d,this.progress=f||d,this.prev=null,this.id=c++,this.next=null,this._done=null,this},done:function(a,c){var d=this.root();return d._done=b.constructorOf(a)?a:new b(a,c),d},_finally:function(a,c){var d=this.root();return d._done&&!d._done.isComplete()&&(d._done.withContext(this.context),c===b.DONE?d._done.resolve(a):c===b.FAIL&&d._done.reject(a)),this},_clearProperty:function(){return this.result=null,this.ands=[],this.todo=d,this.fail=d,this.progress=d,this.prev=null,this.next=null,this.state=b.TODO,this._done=null,this},destroy:function(){var a,b,c=this.ands,d=c.length;for(a=d-1;a>=0;a--)b=c[a],b.destroy(),b=c.pop();this.parent&&(this.parent.next=null),this.next&&this.next.destroy(),this._clearProperty()},resolve:function(a){if(this.isComplete())return this;try{this.state=b.DONE,this.result=this.call(b.TODO,a)}catch(c){return this.state=b.TODO,this.reject(a)}if(b.constructorOf(this.result)&&this.result!==this){var d=this.result._done||this.result;switch(d.state){case b.DONE:return this.result=d.result,this._nextResolve(this.result),this._resolveAnds(a);case b:return this.result=d.result,this.reject(this.result)}var e=this,f=function(a){e.state=b.DONE,e.result=a,e._nextResolve(a),e=g=f=h=null,d.next.destroy()},g=this.result.fail,h=this.result.progress;this.state=b.TODO,d.state===b.FAIL?(e.reject(d.result),e=g=f=h=null):d.fail=function(a){g.call(d.context,a),e.reject(a),e=g=f=h=null,d.next.destroy()},d.then(f)}else this._nextResolve(this.result);return this._resolveAnds(a)},_resolveAnds:function(a){for(var b=0,c=this.ands.length;c>b;b++)this.ands[b].resolve(a);return this},_reprocessAnds:function(a){for(var b=0,c=this.ands.length;c>b;b++)this.ands[b].reprocess(a);return this},reject:function(a){if(this.isComplete())return this;if(this.state=b.FAIL,this.result=this.call(b.FAIL,a),b.constructorOf(this.result)&&this.result!==this){var c=this.result;switch(c.state){case b.DONE:this.result=c.result,this._nextResolve(this.result,!0);break;case b.FAIL:this.result=c.result,this._nextReject(this.result)}}else this._nextReject(this.result,!0);return this._resolveAnds(a)},reprocess:function(a){if(this.isComplete())return this;this.state=b.PROGRESS;var c=this.call(b.PROGRESS,a);if(b.constructorOf(c)&&c!==this)switch(this.state=b.TODO,c.state){case b.TODO:this.resolve(c.resolve(a).result);break;case b.DONE:this.resolve(c.result);break;case b.FAIL:this.reject(c.result)}return this._reprocessAnds(a)},and:function(a,b,c){var d=this._createPromiseWithoutPrev(a,b,c).withContext(this).done(e,e);return this._push(d),this.isComplete()&&d.resolve(this.result),this},root:function(){for(var a=this;a.prev;)a=a.prev;return a},end:function(){for(var a=this;a.next;)a=a.next;return a},isComplete:function(){return this.state===b.DONE||this.state===b.FAIL}},b.constructorOf=function(a){return a instanceof b||(a?a.__promiseFlag===!0:!1)},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=b),exports.Promise=b):"function"==typeof define&&define.amd?define(function(){return b}):a.Promise=b}(window);